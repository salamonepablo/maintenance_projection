warning: in the working copy of 'maintenance/services/access_extractor.py', LF will be replaced by CRLF the next time Git touches it
[1mdiff --git a/maintenance/services/access_extractor.py b/maintenance/services/access_extractor.py[m
[1mindex c6d9f3a..341884f 100644[m
[1m--- a/maintenance/services/access_extractor.py[m
[1m+++ b/maintenance/services/access_extractor.py[m
[36m@@ -6,11 +6,11 @@[m [mEste servicio extrae datos de Access para sincronizar con Django.[m
 Fuentes de datos:[m
 - A_00_Kilometrajes: Lecturas de od√≥metro[m
 - A_00_OT_Simaf: Eventos de mantenimiento[m
[31m-- 01_Coches: Maestro de coches[m
[31m-- 11_CambioCoches: Relaci√≥n Coche-M√≥dulo[m
[31m-- 12_CambioM√≥dulos: Relaci√≥n M√≥dulo-Formaci√≥n[m
[32m+[m[32m- A_00_M√≥dulos: Maestro de m√≥dulos con Clase_Veh√≠culos[m
 [m
[31m-Filtro: Solo m√≥dulos CSR (M√≥dulo LIKE 'M%')[m
[32m+[m[32mJOIN validado:[m[41m [m
[32m+[m[32m- ot.M√≥dulo (FK int) = m.Id_M√≥dulos (PK int)[m
[32m+[m[32m- Filtro: m.Clase_Veh√≠culos = 3 (CSR)[m
 """[m
 from __future__ import annotations[m
 [m
[36m@@ -183,7 +183,9 @@[m [mclass AccessExtractor:[m
         Obtiene lista de m√≥dulos CSR activos.[m
         [m
         Extrae m√≥dulos √∫nicos de A_00_Kilometrajes y A_00_OT_Simaf,[m
[31m-        filtrando por Clase_Veh√≠culos = 'C' (CSR) mediante JOIN con A_00_M√≥dulos.[m
[32m+[m[32m        filtrando por Clase_Veh√≠culos = 3 (CSR) mediante JOIN con A_00_M√≥dulos.[m
[32m+[m[41m        [m
[32m+[m[32m        JOIN validado: ot.M√≥dulo (FK int) = m.Id_M√≥dulos (PK int)[m
         [m
         Returns:[m
             Lista de ModuleData[m
[36m@@ -194,13 +196,13 @@[m [mclass AccessExtractor:[m
         cursor = self.conn.cursor()[m
         modules_dict: Dict[str, ModuleData] = {}[m
         [m
[31m-        # Obtener m√≥dulos de kilometrajes (CSR: Clase_Veh√≠culos = 'C')[m
[32m+[m[32m        # Obtener m√≥dulos de kilometrajes (CSR: Clase_Veh√≠culos = 3)[m
         try:[m
             cursor.execute("""[m
[31m-                SELECT DISTINCT m.M√≥dulos, m.Id_M√≥dulos[m
[32m+[m[32m                SELECT DISTINCT m.M√≥dulos[m
                 FROM A_00_Kilometrajes AS k[m
                 INNER JOIN A_00_M√≥dulos AS m ON k.M√≥dulo = m.Id_M√≥dulos[m
[31m-                WHERE m.Clase_Veh√≠culos = 'C'[m
[32m+[m[32m                WHERE m.Clase_Veh√≠culos = 3[m
                 ORDER BY m.M√≥dulos[m
             """)[m
             [m
[36m@@ -216,13 +218,13 @@[m [mclass AccessExtractor:[m
         except pyodbc.Error as e:[m
             print(f"Error obteniendo m√≥dulos de kilometrajes: {e}")[m
         [m
[31m-        # Obtener m√≥dulos de mantenimientos (CSR: Clase_Veh√≠culos = 'C')[m
[32m+[m[32m        # Obtener m√≥dulos de mantenimientos (CSR: Clase_Veh√≠culos = 3)[m
         try:[m
             cursor.execute("""[m
[31m-                SELECT DISTINCT m.M√≥dulos, m.Id_M√≥dulos[m
[32m+[m[32m                SELECT DISTINCT m.M√≥dulos[m
                 FROM A_00_OT_Simaf AS ot[m
                 INNER JOIN A_00_M√≥dulos AS m ON ot.M√≥dulo = m.Id_M√≥dulos[m
[31m-                WHERE m.Clase_Veh√≠culos = 'C'[m
[32m+[m[32m                WHERE m.Clase_Veh√≠culos = 3[m
             """)[m
             [m
             for row in cursor.fetchall():[m
[36m@@ -266,7 +268,8 @@[m [mclass AccessExtractor:[m
         """[m
         Obtiene eventos de mantenimiento desde A_00_OT_Simaf.[m
         [m
[31m-        Filtra por Clase_Veh√≠culos = 'C' (CSR) mediante JOIN con A_00_M√≥dulos.[m
[32m+[m[32m        Filtra por Clase_Veh√≠culos = 3 (CSR) mediante JOIN validado.[m
[32m+[m[32m        JOIN: ot.M√≥dulo (FK int) = m.Id_M√≥dulos (PK int)[m
         [m
         Args:[m
             module_id: Filtrar por m√≥dulo espec√≠fico (ej: 'M01')[m
[36m@@ -281,12 +284,12 @@[m [mclass AccessExtractor:[m
         cursor = self.conn.cursor()[m
         events = [][m
         [m
[31m-        # Construir query (CSR: Clase_Veh√≠culos = 'C')[m
[32m+[m[32m        # Construir query (CSR: Clase_Veh√≠culos = 3)[m
         query = """[m
             SELECT m.M√≥dulos, ot.Tarea, ot.Km, ot.Fecha_Fin[m
             FROM A_00_OT_Simaf AS ot[m
             INNER JOIN A_00_M√≥dulos AS m ON ot.M√≥dulo = m.Id_M√≥dulos[m
[31m-            WHERE m.Clase_Veh√≠culos = 'C'[m
[32m+[m[32m            WHERE m.Clase_Veh√≠culos = 3[m
         """[m
         params = [][m
         [m
[36m@@ -345,7 +348,8 @@[m [mclass AccessExtractor:[m
         """[m
         Obtiene lecturas de od√≥metro desde A_00_Kilometrajes.[m
         [m
[31m-        Filtra por Clase_Veh√≠culos = 'C' (CSR) mediante JOIN con A_00_M√≥dulos.[m
[32m+[m[32m        Filtra por Clase_Veh√≠culos = 3 (CSR) mediante JOIN validado.[m
[32m+[m[32m        JOIN: k.M√≥dulo (FK int) = m.Id_M√≥dulos (PK int)[m
         [m
         Args:[m
             module_id: Filtrar por m√≥dulo espec√≠fico (ej: 'M01')[m
[36m@@ -361,7 +365,7 @@[m [mclass AccessExtractor:[m
         cursor = self.conn.cursor()[m
         readings = [][m
         [m
[31m-        # Construir query (CSR: Clase_Veh√≠culos = 'C')[m
[32m+[m[32m        # Construir query (CSR: Clase_Veh√≠culos = 3)[m
         query_parts = ["SELECT"][m
         if limit:[m
             query_parts.append(f"TOP {limit}")[m
[36m@@ -369,7 +373,7 @@[m [mclass AccessExtractor:[m
         query_parts.append("m.M√≥dulos, k.kilometraje, k.Fecha")[m
         query_parts.append("FROM A_00_Kilometrajes AS k")[m
         query_parts.append("INNER JOIN A_00_M√≥dulos AS m ON k.M√≥dulo = m.Id_M√≥dulos")[m
[31m-        query_parts.append("WHERE m.Clase_Veh√≠culos = 'C'")[m
[32m+[m[32m        query_parts.append("WHERE m.Clase_Veh√≠culos = 3")[m
         [m
         params = [][m
         [m
[36m@@ -434,6 +438,8 @@[m [mclass AccessExtractor:[m
         """[m
         Prueba la conexi√≥n y retorna estad√≠sticas b√°sicas.[m
         [m
[32m+[m[32m        Cuenta registros CSR (Clase_Veh√≠culos = 3) mediante JOIN validado.[m
[32m+[m[41m        [m
         Returns:[m
             Dict con informaci√≥n de la conexi√≥n[m
         """[m
[36m@@ -445,30 +451,30 @@[m [mclass AccessExtractor:[m
         stats = {"connected": True}[m
         [m
         try:[m
[31m-            # Contar m√≥dulos (CSR: Clase_Veh√≠culos = 'C')[m
[32m+[m[32m            # Contar m√≥dulos (CSR: Clase_Veh√≠culos = 3)[m
             cursor.execute("""[m
                 SELECT COUNT(DISTINCT m.M√≥dulos)[m
                 FROM A_00_Kilometrajes AS k[m
                 INNER JOIN A_00_M√≥dulos AS m ON k.M√≥dulo = m.Id_M√≥dulos[m
[31m-                WHERE m.Clase_Veh√≠culos = 'C'[m
[32m+[m[32m                WHERE m.Clase_Veh√≠culos = 3[m
             """)[m
             stats["modules_count"] = cursor.fetchone()[0][m
             [m
[31m-            # Contar eventos (CSR: Clase_Veh√≠culos = 'C')[m
[32m+[m[32m            # Contar eventos (CSR: Clase_Veh√≠culos = 3)[m
             cursor.execute("""[m
                 SELECT COUNT(*)[m
                 FROM A_00_OT_Simaf AS ot[m
                 INNER JOIN A_00_M√≥dulos AS m ON ot.M√≥dulo = m.Id_M√≥dulos[m
[31m-                WHERE m.Clase_Veh√≠culos = 'C'[m
[32m+[m[32m                WHERE m.Clase_Veh√≠culos = 3[m
             """)[m
             stats["events_count"] = cursor.fetchone()[0][m
             [m
[31m-            # Contar lecturas (CSR: Clase_Veh√≠culos = 'C')[m
[32m+[m[32m            # Contar lecturas (CSR: Clase_Veh√≠culos = 3)[m
             cursor.execute("""[m
                 SELECT COUNT(*)[m
                 FROM A_00_Kilometrajes AS k[m
                 INNER JOIN A_00_M√≥dulos AS m ON k.M√≥dulo = m.Id_M√≥dulos[m
[31m-                WHERE m.Clase_Veh√≠culos = 'C'[m
[32m+[m[32m                WHERE m.Clase_Veh√≠culos = 3[m
             """)[m
             stats["readings_count"] = cursor.fetchone()[0][m
             [m
